<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= community.Community_Name %> Posts</title>
  <link rel="stylesheet" href="/styles/communityposts.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .container {
      position: relative; /* Ensure relative positioning for absolute positioning inside */
    }
    .add-post-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #ff69b4; /* Pink color */
      color: white;
      border: none;
      padding: 20px;
      font-size: 18px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1000; /* Ensure it's above other content */
    }
    .add-post-button:hover {
      background-color: #ff1493; /* Darker pink on hover */
    }
  </style>
  <script>
    $(document).ready(function() {
      // Example of handling click event for the add post button
      $('.add-post-button').click(function() {
        // Handle click event, for example, redirecting to a new post page
        window.location.href = '/new-post?community_id=<%= community.Community_Id %>';
      });
      // Scroll to the bottom of the page on load
      scrollToBottom();
    });

    function scrollToBottom() {
      // Scroll to the bottom of the page
      window.scrollTo(0, document.body.scrollHeight);
    }
    $(document).ready(function() {
    // Function to update like count
    function updateLikeCount(postId, newLikeCount) {
      $('#like-count-' + postId).text(newLikeCount);
    }

    // Function to update dislike count
    function updateDislikeCount(postId, newDislikeCount) {
      $('#dislike-count-' + postId).text(newDislikeCount);
    }

    // Function to set button colors based on reaction status
    function setButtonColors() {
      $('.like-button').each(function() {
        const reactionStatus = $(this).data('reaction-status');
        if (reactionStatus === 1) {
          $(this).css('background-color', 'green');
          $(this).siblings('.dislike-button').css('background-color', 'pink');
        } else if (reactionStatus === 2) {
          $(this).css('background-color', 'pink');
          $(this).siblings('.dislike-button').css('background-color', 'green');
        } else {
          $(this).css('background-color', '');
          $(this).siblings('.dislike-button').css('background-color', '');
        }
      });
    }

    setButtonColors();

    // Like button click event
    $('.like-button').click(function() {
      const postId = $(this).data('post-id');
      $.ajax({
        url: '/like',
        method: 'POST',
        data: { postId: postId },
        success: function(response) {
          console.log('Like Success:', response);
          updateLikeCount(postId, response.newLikeCount); // Update like count from server response
          updateDislikeCount(postId, response.newDislikeCount); // Update dislike count from server response
          setButtonColors(); // Update button colors
        },
        error: function(err) {
          console.error('Like Error:', err);
          // Handle errors or display error message
        }
      });
    });

    // Dislike button click event
    $('.dislike-button').click(function() {
      const postId = $(this).data('post-id');
      $.ajax({
        url: '/dislike',
        method: 'POST',
        data: { postId: postId },
        success: function(response) {
          console.log('Dislike Success:', response);
          updateDislikeCount(postId, response.newDislikeCount); // Update dislike count from server response
          updateLikeCount(postId, response.newLikeCount); // Update like count from server response
          setButtonColors(); // Update button colors
        },
        error: function(err) {
          console.error('Dislike Error:', err);
          // Handle errors or display error message
        }
      });
    });
  });

  </script>
</head>
<body>
  <div class="container">
    <!-- Make the community name a clickable link -->
    <h1><a href="/community/<%= community.Community_Id %>"><%= community.Community_Name %></a></h1>
    <!-- Back Button -->
    <a href="/explore" class="back-button">Back to Explore</a>
    <div class="posts">
      <% posts.forEach(post => { %>
        <div class="post-card">
          <div class="post-img">
            <% if (post.imageURL) { %>
              <img src="data:image/jpeg;base64,<%= post.imageURL.toString('base64') %>" alt="Post Image">
            <% } else { %>
              <img src="/images/logo.png" alt="Default Image">
            <% } %>
          </div>
          <div class="post-details">
            <span><i class="fa fa-user"></i> <%= post.Author %></span>
            <span><i class="fa fa-calendar"></i> <%= new Date(post.Posted_on).toLocaleDateString() %></span>
          </div>
          <div class="post-text">
            <p><%= post.Description %></p>
          </div>
          <div class="post-actions">
            <button class="view-comments-button" data-post-id="<%= post.PostID %>">
                <a href="/community/<%= community.Community_Id %>/post/<%= post.PostID %>/comments" class="link-button">View Comments</a>
            </button>
            <!-- Like Button -->
            <button class="like-button" data-post-id="<%= post.PostID %>" data-reaction-status="<%= post.reaction_status %>">
              Like (<span id="like-count-<%= post.PostID %>"><%= post.Likes %></span>)
            </button>
            <!-- Dislike Button -->
            <button class="dislike-button" data-post-id="<%= post.PostID %>" data-reaction-status="<%= post.reaction_status %>">
              Dislike (<span id="dislike-count-<%= post.PostID %>"><%= post.Dislikes %></span>)
            </button>
            <% if (post.productLink) { %>
              <a href="<%= post.productLink %>" target="_blank" class="link-button">Link to Product</a>
            <% } else { %>
              <span>No link available</span>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
    <!-- Example button on the community page -->
    <a href="/new-post?community_id=<%= community.Community_Id %>" class="add-post-button">Add Post +</a>
  </div>
</body>
</html>